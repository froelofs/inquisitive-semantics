{%- comment -%}
See http://hamishwillee.github.io/2014/11/13/jekyll-includes-are-functions/
{%- endcomment -%}

{%- assign dataFile = include.dataFile -%}
{%- assign object = include.object -%}
{%- assign field = include.field -%}

{%- comment -%}
First we check if the object is an array or a string. 
We can do this using object.first: https://stackoverflow.com/questions/38917552/check-if-variable-is-type-of-string-or-array-in-liquid
If it is an array, we define a defaultObject, which initially is just an empty
array. To create such a thing in liquid you need to do strange things, see
https://blog.rampatra.com/how-to-create-an-array-in-liquid
Then we check if there exists an object in the data file, and if so we use
that as a default object. We output the field, either from the object or the default object
{%- endcomment -%}
{%- if object.first -%}

  {%- comment -%}
    If the object is a hash of the form `id: {id: ...}`,
    then object[0] is the key and object[1] is the actual
    object. We only look the latter (so currently you still 
    have to specify the id!)
    https://stackoverflow.com/questions/51211556/check-if-variable-type-is-hash-or-array-in-liquid
  {%- endcomment -%}
  {%- if object.first.first -%}
  {%- else -%}
    {%- assign object = object[1] -%}
  {%- endif -%}

  {%- assign defaultObject = "" | split: "," -%}
  {%- if object contains "id" -%}
    {%- if dataFile contains object["id"] -%}
      {%- assign defaultObject = dataFile[object["id"]] -%}
    {%- endif -%}
  {%- endif -%}

  {%- if object contains field -%}
    {{ object[field] }}
  {%- elsif defaultObject contains field -%}
    {{ defaultObject[field] }}
  {%- endif -%}

{%- comment -%}
  object is not an array, but a string
{%- endcomment -%}
{%- else -%}
  {%- comment -%}
    If the object exists, try to output 
  {%- endcomment -%}
  {%- if dataFile contains object -%}
    {%- if dataFile[object] contains field -%}
      {{ dataFile[object][field] }}
    {%- endif -%}

  {%- comment -%}
    object does not exist, output raw text only if field = 'fulltext'
  {%- endcomment -%}
  {%- elsif field == "fulltext" -%}
    {{ object }}
  {%- endif -%}
{%- endif -%}